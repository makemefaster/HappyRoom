<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Room Allocator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .room-card { transition: all 0.2s; }
        .room-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }
        .conflict { color: #dc2626; font-weight: bold; background-color: #fee2e2; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
        .match { color: #059669; font-weight: bold; background-color: #d1fae5; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; margin-left: 4px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #3b82f6; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4 md:p-8 font-sans text-slate-800">

    <div class="max-w-5xl mx-auto">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-slate-900">Room Allocator</h1>
            <p class="text-slate-500 mt-2">Upload Excel data to optimize classroom seating based on variable friend preferences.</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-8">
            <h2 class="text-lg font-bold mb-4 flex items-center">
                <span class="bg-blue-600 text-white w-6 h-6 rounded-full inline-flex items-center justify-center text-xs mr-2">1</span>
                Configuration
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">Room Sizes</label>
                    <input type="text" id="roomSizes" placeholder="e.g. 4, 4, 6, 8" value="4, 4, 4, 4" 
                           class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <p class="text-xs text-slate-500 mt-1">Comma separated (e.g., 5, 5, 6).</p>
                </div>

                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-1">How many friends can they choose?</label>
                    <select id="friendCount" onchange="updateInstructions()" class="w-full p-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                        <option value="2" selected>2 Friends</option>
                        <option value="3">3 Friends</option>
                        <option value="4">4 Friends</option>
                        <option value="5">5 Friends</option>
                    </select>
                    <p class="text-xs text-slate-500 mt-1" id="columnInstruction">
                        Structure: Col A (Name), B-C (Friends), D (Avoid)
                    </p>
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-semibold text-slate-700 mb-1">Upload Excel (.xlsx)</label>
                <div class="flex items-center justify-center w-full">
                    <label for="fileInput" class="flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100">
                        <div class="flex flex-col items-center justify-center pt-5 pb-6">
                            <svg class="w-8 h-8 mb-4 text-slate-500" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 16">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 13h3a3 3 0 0 0 0-6h-.025A5.56 5.56 0 0 0 16 6.5 5.5 5.5 0 0 0 5.207 5.021C5.137 5.017 5.071 5 5 5a4 4 0 0 0 0 8h2.167M10 15V6m0 0L8 8m2-2 2 2"/>
                            </svg>
                            <p class="text-sm text-slate-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                            <p class="text-xs text-slate-500">.XLSX files only</p>
                        </div>
                        <input id="fileInput" type="file" class="hidden" accept=".xlsx, .xls" />
                    </label>
                </div>
                <div id="fileName" class="text-sm text-blue-600 mt-2 font-medium hidden"></div>
            </div>

            <button onclick="processData()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow transition w-full md:w-auto flex items-center justify-center">
                <span id="btnText">Generate Allocation</span>
                <span id="loader" class="spinner hidden"></span>
            </button>
        </div>

        <div id="resultsArea" class="hidden animate-fade-in">
            <div class="flex justify-between items-end mb-6 border-b border-slate-200 pb-2">
                <div>
                    <h2 class="text-xl font-bold text-slate-800">Results</h2>
                    <p class="text-sm text-slate-500">Based on <span id="iterationsDisplay">0</span> simulations</p>
                </div>
                <div class="text-right">
                    <div class="text-xs text-slate-500 uppercase tracking-wide">Happiness Score</div>
                    <div id="scoreDisplay" class="text-3xl font-black text-blue-600">0</div>
                </div>
            </div>
            
            <div id="roomsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                </div>
        </div>
    </div>

    <script>
        let students = [];

        // UI Helper: Update instructions based on dropdown
        function updateInstructions() {
            const count = parseInt(document.getElementById('friendCount').value);
            const friendCols = Array.from({length: count}, (_, i) => String.fromCharCode(66 + i)).join('-'); // B-C or B-E
            const avoidCol = String.fromCharCode(66 + count); // Column after friends
            document.getElementById('columnInstruction').innerText = 
                `Structure: Col A (Name) | Cols ${friendCols} (Friends) | Col ${avoidCol} (Avoid)`;
        }

        // UI Helper: Show filename
        document.getElementById('fileInput').addEventListener('change', function(e) {
            if(e.target.files[0]) {
                const nameDiv = document.getElementById('fileName');
                nameDiv.innerText = "Selected: " + e.target.files[0].name;
                nameDiv.classList.remove('hidden');
            }
        });

        async function processData() {
            const fileInput = document.getElementById('fileInput');
            const roomInput = document.getElementById('roomSizes').value;
            const friendLimit = parseInt(document.getElementById('friendCount').value);
            const btnText = document.getElementById('btnText');
            const loader = document.getElementById('loader');
            
            if (!fileInput.files.length) {
                alert("Please select an Excel file first.");
                return;
            }

            const sizes = roomInput.split(',').map(s => parseInt(s.trim())).filter(n => !isNaN(n));
            if (sizes.length === 0) {
                alert("Please enter valid room sizes.");
                return;
            }

            // Show Loading State
            btnText.innerText = "Optimizing...";
            loader.classList.remove('hidden');
            
            // Allow UI to update before heavy processing
            setTimeout(async () => {
                try {
                    const file = fileInput.files[0];
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(data);
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, {header: 1});

                    // Parse Students based on dynamic friend limit
                    // Row Structure: Name (0) | Friends (1 to limit) | Avoid (limit + 1)
                    students = jsonData.filter(row => row[0]).map(row => {
                        const likes = [];
                        // Loop through the friend columns
                        for(let i = 1; i <= friendLimit; i++) {
                            if(row[i]) likes.push(row[i]);
                        }
                        
                        return {
                            name: row[0],
                            likes: likes,
                            dislike: row[friendLimit + 1] || null
                        };
                    });

                    // Validation
                    const totalCapacity = sizes.reduce((a, b) => a + b, 0);
                    if (totalCapacity < students.length) {
                        alert(`Error: ${students.length} students but only ${totalCapacity} spaces.`);
                        throw new Error("Capacity");
                    }

                    // Run Algorithm
                    const bestAllocation = optimizeRooms(students, sizes);
                    renderResults(bestAllocation);

                } catch (e) {
                    console.error(e);
                    if(e.message !== "Capacity") alert("An error occurred parsing the file. Please check the column format.");
                } finally {
                    btnText.innerText = "Generate Allocation";
                    loader.classList.add('hidden');
                }
            }, 100);
        }

        function optimizeRooms(studentList, roomSizes) {
            let bestRooms = [];
            let bestScore = -Infinity;
            const totalAttempts = 50; 
            const swapsPerAttempt = 2500;

            document.getElementById('iterationsDisplay').innerText = (totalAttempts * swapsPerAttempt).toLocaleString();

            for (let attempt = 0; attempt < totalAttempts; attempt++) {
                let currentRooms = initializeRooms(studentList, roomSizes);
                let currentScore = calculateScore(currentRooms);

                // Optimization Loop (Stochastic Hill Climbing)
                for (let i = 0; i < swapsPerAttempt; i++) {
                    const newRooms = JSON.parse(JSON.stringify(currentRooms));
                    
                    // Pick two distinct random rooms
                    const r1Idx = Math.floor(Math.random() * newRooms.length);
                    let r2Idx = Math.floor(Math.random() * newRooms.length);
                    while(r1Idx === r2Idx) r2Idx = Math.floor(Math.random() * newRooms.length);
                    
                    const r1 = newRooms[r1Idx];
                    const r2 = newRooms[r2Idx];

                    // Determine Swap Type
                    // 1. Move from R1 to R2 (if R2 has space)
                    // 2. Swap student between R1 and R2
                    
                    if (r1.occupants.length > 0 && r2.occupants.length < r2.capacity && Math.random() > 0.5) {
                        // Move
                        const sIdx = Math.floor(Math.random() * r1.occupants.length);
                        const student = r1.occupants.splice(sIdx, 1)[0];
                        r2.occupants.push(student);
                    } else if (r1.occupants.length > 0 && r2.occupants.length > 0) {
                        // Swap
                        const s1Idx = Math.floor(Math.random() * r1.occupants.length);
                        const s2Idx = Math.floor(Math.random() * r2.occupants.length);
                        
                        const temp = r1.occupants[s1Idx];
                        r1.occupants[s1Idx] = r2.occupants[s2Idx];
                        r2.occupants[s2Idx] = temp;
                    }

                    const newScore = calculateScore(newRooms);
                    // Accept if better
                    if (newScore > currentScore) {
                        currentRooms = newRooms;
                        currentScore = newScore;
                    }
                }

                if (currentScore > bestScore) {
                    bestScore = currentScore;
                    bestRooms = currentRooms;
                }
            }
            return bestRooms;
        }

        function initializeRooms(studentList, roomSizes) {
            let shuffled = [...studentList].sort(() => 0.5 - Math.random());
            let rooms = roomSizes.map((size, index) => ({ id: index + 1, capacity: size, occupants: [] }));
            
            let studentIndex = 0;
            for (let room of rooms) {
                while (room.occupants.length < room.capacity && studentIndex < shuffled.length) {
                    room.occupants.push(shuffled[studentIndex++]);
                }
            }
            return rooms;
        }

        function calculateScore(rooms) {
            let score = 0;
            rooms.forEach(room => {
                const occupants = room.occupants;
                const namesInRoom = occupants.map(s => s.name.toLowerCase().trim());

                occupants.forEach(student => {
                    // +10 for every friend in the room
                    student.likes.forEach(friend => {
                        if (friend && namesInRoom.includes(friend.toLowerCase().trim())) {
                            score += 10;
                        }
                    });

                    // -500 for an enemy (Make this penalty massive to strictly enforce it)
                    if (student.dislike && namesInRoom.includes(student.dislike.toLowerCase().trim())) {
                        score -= 500;
                    }
                });
            });
            return score;
        }

        function renderResults(rooms) {
            const container = document.getElementById('roomsContainer');
            const resultsArea = document.getElementById('resultsArea');
            const scoreDisplay = document.getElementById('scoreDisplay');
            
            container.innerHTML = '';
            resultsArea.classList.remove('hidden');
            scoreDisplay.innerText = calculateScore(rooms);

            rooms.forEach(room => {
                const div = document.createElement('div');
                div.className = 'bg-white rounded-xl shadow border border-slate-200 overflow-hidden room-card flex flex-col h-full';
                
                // Room Header
                const isFull = room.occupants.length === room.capacity;
                div.innerHTML = `
                    <div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center">
                        <h3 class="font-bold text-slate-700">Room ${room.id}</h3>
                        <span class="text-xs font-mono px-2 py-1 rounded ${isFull ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
                            ${room.occupants.length}/${room.capacity}
                        </span>
                    </div>
                `;

                // Student List
                const ul = document.createElement('ul');
                ul.className = 'p-4 space-y-3 flex-grow';
                
                const namesInRoom = room.occupants.map(s => s.name.toLowerCase().trim());

                room.occupants.forEach(student => {
                    let matchesHtml = '';
                    
                    // Generate Hearts
                    student.likes.forEach(l => {
                        if (l && namesInRoom.includes(l.toLowerCase().trim())) {
                            matchesHtml += `<span class="match" title="With friend: ${l}">♥ ${l}</span>`;
                        }
                    });

                    // Generate Conflict Warning
                    if (student.dislike && namesInRoom.includes(student.dislike.toLowerCase().trim())) {
                        matchesHtml += `<span class="conflict" title="Conflict with: ${student.dislike}">⚠ ${student.dislike}</span>`;
                    }

                    const li = document.createElement('li');
                    li.className = 'text-sm text-slate-700 flex flex-col pb-2 border-b border-slate-50 last:border-0 last:pb-0';
                    li.innerHTML = `
                        <div class="font-medium">${student.name}</div>
                        <div class="flex flex-wrap gap-1 mt-1 h-5">${matchesHtml}</div>
                    `;
                    ul.appendChild(li);
                });

                div.appendChild(ul);
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
